<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css" />
  <link rel="stylesheet" href="./styles/main.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
  <title>Dreamarket - Descuentos</title>
</head>

<body>
  <div id="navbar-placeholder"></div>
  <section class="section">
    <div class="container">
      <div class="swiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide">
            <figure class="image is-5by1">
              <img src="./imagenes/banner_ofertas.png">
            </figure>
          </div>
          <div class="swiper-slide">
            <figure class="image is-16by7">
              <img src="./imagenes/banner_ofertas2.png">
            </figure>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    new Swiper('.swiper', {
      loop: true,
      autoplay: { delay: 3000 }
    });
  </script>

  <section class="section">
    <div class="container">
      <h1 class="title">Descuentos del día</h1>
      <p class="subtitle">Aprovechá las mejores ofertas disponibles hoy</p>
      <div id="descuentos-dia" class="columns is-multiline"></div>
    </div>
  </section>

  <hr>

  <section class="section">
    <div class="container">
      <h1 class="title">3x2 en los siguientes productos</h1>
      <p class="subtitle">Stockeate sin gastar de más!</p>
      <div id="descuentos-3x2" class="columns is-multiline"></div>
    </div>
  </section>

  <hr>

  <section class="section">
    <div class="container">
      <h1 class="title" id="Dreamweek">¡Especial Dreamweek!</h1>
      <p class="subtitle">La semana que siempre soñaste, con los mejores precios!</p>
      <div id="descuentos-dreamweek" class="columns is-multiline"></div>
    </div>
  </section>

  <div class="modal" id="modal-perfil">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Mi perfil</p>
        <button class="delete" aria-label="close" id="btn-cerrar-modal"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">E-mail</label>
          <div class="control">
            <input id="perfil-email" class="input" type="email" disabled>
          </div>
        </div>

        <div class="field">
          <label class="label">Nombre</label>
          <div class="control">
            <input id="perfil-nombre" class="input" type="text">
          </div>
        </div>

        <div class="field">
          <label class="label">Apellido</label>
          <div class="control">
            <input id="perfil-apellido" class="input" type="text">
          </div>
        </div>

        <div class="field">
          <label class="label">Teléfono</label>
          <div class="control">
            <input id="perfil-telefono" class="input" type="text">
          </div>
        </div>

        <div class="field">
          <label class="label">Dirección</label>
          <div class="control">
            <input id="perfil-direccion" class="input" type="text">
          </div>
        </div>

        <div class="field">
          <label class="label">Contraseña</label>
          <div class="control">
            <input id="perfil-contrasenia" class="input" type="password"
              placeholder="Escribí tu nueva contraseña">
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-primary is-profile" id="btn-modificar-perfil"
          onclick="modificar_usuario()">Modificar perfil</button>
        <button class="button is-profile is-danger" id="btn-eliminar-cuenta" onclick="eliminar_cuenta()">Eliminar
          cuenta</button>
        <button class="button is-primary is-profile" id="btn-modificar-perfil" onclick="cerrar_sesion()">Cerrar
          sesion</button>
      </footer>
    </div>
  </div>

  <div id="footer-placeholder"></div>
  <script src = "./js/perfil.js">
    
  </script>
  <script>
      async function cargarFooter() {
        const respuesta = await fetch("./footer.html");
        const html = await respuesta.text();
        document.getElementById("footer-placeholder").innerHTML = html;
      }
      cargarFooter();
    const URL_PRODUCTOS = "http://localhost:3000/productos";
    const regex_porcentaje = /^[0-9]+%$/;
    const regex_3x2 = /3x2/i;
    const regex_dreamweek = /dreamweek/i;

    function mostrar_productos(id_contenedor, productos) {
      const contenedor = document.getElementById(id_contenedor);
      contenedor.innerHTML = "";

      productos.forEach(producto => {
        const descuento = (producto.descuento || "").trim();

        let num_descuento = 0;
        let tags_html = "";

        if (regex_porcentaje.test(descuento)) {
          num_descuento = parseInt(descuento.replace("%", ""));
          tags_html = `<span class="tag is-danger is-light" style="margin-top:5px">${num_descuento}% OFF</span>`;
        }
        else if (regex_3x2.test(descuento)) {
          tags_html = `<span class="tag is-danger is-light" style="margin-top:5px">${descuento}</span>`;
        }
        else if (regex_dreamweek.test(descuento)) {
          num_descuento = 50;
          tags_html = `
            <span class="tag dreamweek-tag" style="margin-top:5px">Dreamweek!</span>
            <span class="tag is-danger is-light" style="margin-top:5px">50% OFF</span>
          `;
        }

        const precio_final = producto.precio - (producto.precio * num_descuento / 100);

        let precio_original_html = "";
        let precio_final_html = "";

        if (num_descuento > 0) {
          precio_original_html = `<s>$${producto.precio}</s>`;
          precio_final_html = `$${precio_final.toFixed(0)}`;
        } else {
          precio_final_html = `$${producto.precio}`;
        }

        contenedor.innerHTML += `
          <div class="column is-one-quarter">
            <div class="card pag-productos">

              <div class="card-image">
                <figure class="image is-4by3">
                  <img src="${producto.imagen}">
                </figure>
              </div>

              <div class="card-content has-text-centered">
                <p class="title is-6">${producto.nombre} ${producto.marca || ""}</p>

                <p class="subtitle is-6">
                  ${precio_original_html}
                  <strong>${precio_final_html}</strong><br>
                  ${tags_html}
                </p>

                <button
                  class="button is-primary is-small btn-agregar-carrito"
                  onclick="clickAgregarProducto(this)"
                  data-id-producto="${producto.id_producto}"
                  data-nombre="${producto.nombre}"
                  data-marca="${producto.marca}"
                  data-precio="${precio_final}"
                  data-imagen="${producto.imagen}"
                  data-descuento="${producto.descuento || ""}">
                  Agregar
                </button>
              </div>

            </div>
          </div>
        `;
      });
    }

    function mezclar(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    async function cargar_descuentos() {

      const respuesta = await fetch(URL_PRODUCTOS);
      let productos = await respuesta.json();

      const productos_porcentaje = productos.filter(
        producto => regex_porcentaje.test(producto.descuento)
      );

      const productos_multiplo = productos.filter(
        producto => regex_3x2.test(producto.descuento)
      );

      const productos_dreamweek = productos.filter(
        producto => regex_dreamweek.test(producto.descuento)
      );

      const cuatro_prod_porcentaje = mezclar(productos_porcentaje).slice(0, 4);
      const cuatro_prod_multiplo = mezclar(productos_multiplo).slice(0, 4);
      const cuatro_prod_dreamweek = mezclar(productos_dreamweek).slice(0, 4);

      mostrar_productos("descuentos-dia", cuatro_prod_porcentaje);
      mostrar_productos("descuentos-3x2", cuatro_prod_multiplo);
      mostrar_productos("descuentos-dreamweek", cuatro_prod_dreamweek);
    }
    cargar_descuentos();

    function obtenerCarrito() {
      const carritoGuardado = localStorage.getItem("dreammarket_carrito");
      if (carritoGuardado === null) {
        
        return [];
      }
      return JSON.parse(carritoGuardado);
    }

    function guardarCarrito(carrito) {
      localStorage.setItem("dreammarket_carrito", JSON.stringify(carrito));
    }

    function agregarProductoAlCarrito(productoParaAgregar) {
      const carritoActual = obtenerCarrito();
      
      const indiceExistente = carritoActual.findIndex(function (item) {
        return item.id_producto === productoParaAgregar.id_producto;
      });

      if (indiceExistente !== -1) {
        carritoActual[indiceExistente].cantidad += 1;
      } else {
        productoParaAgregar.cantidad = 1;
        carritoActual.push(productoParaAgregar);
      }

      guardarCarrito(carritoActual);
    }

    
    function clickAgregarProducto(boton) {
      const productoParaAgregar = {
        id_producto: Number(boton.dataset.idProducto),
        nombre: boton.dataset.nombre,
        marca: boton.dataset.marca,
        imagen: boton.dataset.imagen,
        precioUnitario: Number(boton.dataset.precio),
        descuento: boton.dataset.descuento || ""
      };
      agregarProductoAlCarrito(productoParaAgregar);
    }
  </script>
</body>

</html>